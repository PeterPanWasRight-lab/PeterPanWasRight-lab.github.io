<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown LaTeX å…¬å¼è½¬æ¢å™¨ & AI åŠ©æ‰‹</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --ai-color: #7c3aed; /* Violet for AI features */
            --ai-hover: #6d28d9;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --border-color: #e2e8f0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 24px;
            box-sizing: border-box;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        p.subtitle {
            margin: 8px 0 0;
            color: #64748b;
            font-size: 0.9rem;
        }

        /* API Key Section */
        .api-section {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .api-input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 250px;
            font-size: 0.9rem;
        }

        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .divider {
            width: 1px;
            height: 24px;
            background-color: var(--border-color);
            margin: 0 8px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .btn:hover {
            background-color: #f1f5f9;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        /* AI Button Styles */
        .btn-ai {
            background-color: var(--ai-color);
            color: white;
            border: none;
        }
        .btn-ai:hover {
            background-color: var(--ai-hover);
            box-shadow: 0 0 10px rgba(124, 58, 237, 0.3);
        }

        .editor-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            height: 60vh;
        }

        @media (max-width: 768px) {
            .editor-area {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        .panel {
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative;
        }

        .panel-header {
            font-weight: 600;
            color: #475569;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        textarea {
            width: 100%;
            flex-grow: 1;
            min-height: 300px;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            resize: none;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            outline: none;
            box-sizing: border-box;
        }

        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 10;
            border-radius: 12px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--ai-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal for Explanation */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .modal h3 {
            margin-top: 0;
            color: var(--ai-color);
        }

        .modal-content {
            margin: 15px 0;
            line-height: 1.6;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-btn {
            background: var(--border-color);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            float: right;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: var(--ai-color); font-weight: 500;">AI æ€è€ƒä¸­...</div>
    </div>

    <header>
        <h1>Markdown å…¬å¼è½¬æ¢ & AI åŠ©æ‰‹</h1>
        <p class="subtitle">æ ‡å‡†è½¬æ¢ï¼š\[...\] \((...)\) â†’ $$...$$ | âœ¨ AI å¢å¼ºï¼šæ™ºèƒ½çº é”™ä¸è§£é‡Š</p>
    </header>

    <div class="api-section">
        <input type="password" id="apiKeyInput" class="api-input" placeholder="è¾“å…¥ Gemini API Key (å¯é€‰)">
    </div>

    <div class="toolbar">
        <input type="file" id="fileInput" accept=".md,.txt" style="display: none;" onchange="handleFileUpload(this)">
        <button class="btn" onclick="document.getElementById('fileInput').click()">
            ğŸ“‚ å¯¼å…¥
        </button>
        <button class="btn btn-primary" onclick="convertText()">
            âš¡ æœ¬åœ°è½¬æ¢
        </button>
        
        <div class="divider"></div>

        <button class="btn btn-ai" onclick="aiFixFormat()">
            âœ¨ AI æ™ºèƒ½çº é”™
        </button>
        <button class="btn btn-ai" onclick="aiExplainSelection()">
            âœ¨ è§£é‡Šé€‰ä¸­
        </button>

        <div class="divider"></div>

        <button class="btn" onclick="downloadResult()">
            ğŸ’¾ ä¸‹è½½
        </button>
        <button class="btn" onclick="copyResult()">
            ğŸ“‹ å¤åˆ¶
        </button>
        <button class="btn" onclick="clearAll()" style="color: #ef4444; border-color: #fee2e2;">
            ğŸ—‘ï¸ æ¸…ç©º
        </button>
    </div>

    <div class="editor-area">
        <div class="panel">
            <div class="panel-header">
                <span>è¾“å…¥ (æ—§æ ¼å¼/æœ‰è¯¯å†…å®¹)</span>
            </div>
            <textarea id="inputArea" placeholder="åœ¨æ­¤ç²˜è´´ Markdown...&#10;&#10;ç¤ºä¾‹:&#10;\[ E=mc^2 \]&#10;å¦‚æœæ˜¯å¤æ‚çš„æˆ–é”™è¯¯çš„ LaTeXï¼Œè¯•è¯•â€œâœ¨ AI æ™ºèƒ½çº é”™â€"></textarea>
        </div>
        <div class="panel">
            <div class="panel-header">
                <span>è¾“å‡º (æ–°æ ¼å¼)</span>
                <span id="statusMsg" style="font-size: 0.8rem; color: var(--primary-color); opacity: 0; transition: opacity 0.5s;">å·²è½¬æ¢!</span>
            </div>
            <textarea id="outputArea" placeholder="ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>
    </div>
    
    <div class="footer">
        æœ¬åœ°è½¬æ¢ 100% ç¦»çº¿è¿è¡Œã€‚AI åŠŸèƒ½éœ€è¿æ¥ Gemini APIã€‚
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h3>âœ¨ Gemini AI è§£æ</h3>
        <div class="modal-content" id="modalContent">
            Loading...
        </div>
        <button class="modal-btn" onclick="closeModal()">å…³é—­</button>
    </div>
</div>

<script>
    const inputArea = document.getElementById('inputArea');
    const outputArea = document.getElementById('outputArea');
    const statusMsg = document.getElementById('statusMsg');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalContent = document.getElementById('modalContent');
    const apiKeyInput = document.getElementById('apiKeyInput');

    // é¢„è®¾çš„ç¯å¢ƒ Key (Canvas ç¯å¢ƒè‡ªåŠ¨æ³¨å…¥)
    const envApiKey = ""; 

    // --- åŸºç¡€åŠŸèƒ½ ---

    // æ ¸å¿ƒè½¬æ¢é€»è¾‘ (æ­£åˆ™)
    function convertLogic(text) {
        if (!text) return "";

        // 1. æ›¿æ¢å—çº§å…¬å¼ \[ ... \] ä¸º $$...$$
        // .trim() å»é™¤å…¬å¼å†…å®¹é¦–å°¾çš„ç©ºæ ¼å’Œæ¢è¡Œ
        let converted = text.replace(/\\\[([\s\S]*?)\\\]/g, (match, p1) => {
            return `$$${p1.trim()}$$`;
        });

        // 2. æ›¿æ¢è¡Œå†…å…¬å¼ \( ... \) ä¸º $$...$$
        // .trim() å»é™¤å…¬å¼å†…å®¹é¦–å°¾çš„ç©ºæ ¼å’Œæ¢è¡Œ
        converted = converted.replace(/\\\(([\s\S]*?)\\\)/g, (match, p1) => {
            return `$$${p1.trim()}$$`;
        });

        return converted;
    }

    function convertText() {
        const text = inputArea.value;
        const result = convertLogic(text);
        outputArea.value = result;
        showStatus("æœ¬åœ°è½¬æ¢æˆåŠŸ!");
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            inputArea.value = e.target.result;
            convertText(); 
            input.value = ''; 
        };
        reader.readAsText(file, 'UTF-8');
    }

    function downloadResult() {
        const content = outputArea.value;
        if (!content) { alert("æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹ï¼"); return; }
        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'converted_file.md';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function copyResult() {
        const content = outputArea.value;
        if (!content) return;
        outputArea.select();
        document.execCommand('copy');
        showStatus("å·²å¤åˆ¶!");
        window.getSelection().removeAllRanges();
    }

    function clearAll() {
        if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) {
            inputArea.value = "";
            outputArea.value = "";
        }
    }

    function showStatus(msg) {
        statusMsg.textContent = msg;
        statusMsg.style.opacity = 1;
        setTimeout(() => { statusMsg.style.opacity = 0; }, 2000);
    }

    // --- AI åŠŸèƒ½ (Gemini API) ---

    function getApiKey() {
        // ä¼˜å…ˆä½¿ç”¨è¾“å…¥æ¡†çš„ Keyï¼Œå…¶æ¬¡ä½¿ç”¨ç¯å¢ƒ Key
        return apiKeyInput.value.trim() || envApiKey;
    }

    async function callGeminiAPI(prompt) {
        const key = getApiKey();
        if (!key) {
            alert("è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ¡†å¡«å…¥ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚");
            return null;
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
        
        const payload = {
            contents: [{ parts: [{ text: prompt }] }]
        };

        try {
            // Exponential backoff logic
            let response;
            let attempt = 0;
            const delays = [1000, 2000, 4000, 8000, 16000];

            while (attempt <= 5) {
                try {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) break; // Success
                    if (response.status === 429) { // Rate limit
                        throw new Error("Rate limit");
                    } else {
                         const errData = await response.json();
                         throw new Error(errData.error?.message || "API Error");
                    }

                } catch (e) {
                    if (attempt === 5) throw e;
                    await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                    attempt++;
                }
            }

            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;

        } catch (error) {
            console.error(error);
            alert("AI è¯·æ±‚å¤±è´¥: " + error.message);
            return null;
        }
    }

    // åŠŸèƒ½ 1: AI æ™ºèƒ½ä¿®å¤æ ¼å¼
    async function aiFixFormat() {
        const text = inputArea.value;
        if (!text) { alert("è¯·è¾“å…¥éœ€è¦ä¿®å¤çš„å†…å®¹"); return; }

        loadingOverlay.style.display = 'flex';
        document.getElementById('loadingText').innerText = "AI æ­£åœ¨ä¿®å¤ LaTeX è¯­æ³•...";

        const prompt = `
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ LaTeX å’Œ Markdown ç¼–è¾‘ã€‚è¯·ä¿®å¤ä»¥ä¸‹æ–‡æœ¬ä¸­çš„ Markdown æ ¼å¼å’Œ LaTeX æ•°å­¦å…¬å¼é”™è¯¯ã€‚
        è¦æ±‚ï¼š
        1. å°†æ‰€æœ‰ LaTeX å…¬å¼æ ‡å‡†åŒ–ä¸º $$ ... $$ åŒ…è£¹ï¼ˆæ— è®ºæ˜¯è¡Œå†…è¿˜æ˜¯å—çº§ï¼‰ã€‚
        2. ä¿®å¤æ˜æ˜¾çš„ LaTeX è¯­æ³•é”™è¯¯ï¼ˆå¦‚ç¼ºå¤±çš„æ‹¬å·ã€æ‹¼å†™é”™è¯¯çš„å‘½ä»¤ï¼‰ã€‚
        3. ä¿æŒåŸæœ‰æ–‡æœ¬å†…å®¹ä¸å˜ï¼Œåªä¿®æ­£æ ¼å¼ã€‚
        4. ç›´æ¥è¾“å‡ºä¿®å¤åçš„ Markdown å†…å®¹ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæˆ–ä»£ç å—æ ‡è®°ã€‚

        å¾…ä¿®å¤æ–‡æœ¬ï¼š
        ${text}
        `;

        const result = await callGeminiAPI(prompt);
        loadingOverlay.style.display = 'none';

        if (result) {
            outputArea.value = result;
            showStatus("AI ä¿®å¤å®Œæˆ!");
        }
    }

    // åŠŸèƒ½ 2: è§£é‡Šé€‰ä¸­å†…å®¹
    async function aiExplainSelection() {
        const start = inputArea.selectionStart;
        const end = inputArea.selectionEnd;
        const selectedText = inputArea.value.substring(start, end);

        if (!selectedText) {
            alert("è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­ã€é€‰ä¸­ã€‘ä¸€æ®µå…¬å¼æˆ–æ–‡æœ¬ï¼");
            return;
        }

        loadingOverlay.style.display = 'flex';
        document.getElementById('loadingText').innerText = "AI æ­£åœ¨è§£æå†…å®¹...";

        const prompt = `
        è¯·ç”¨ç®€æ´æ˜“æ‡‚çš„ä¸­æ–‡è§£é‡Šä»¥ä¸‹æ•°å­¦å…¬å¼æˆ–æ–‡æœ¬ç‰‡æ®µçš„å«ä¹‰ï¼š
        "${selectedText}"
        
        å¦‚æœæ˜¯å…¬å¼ï¼Œè¯·è§£é‡Šå…¶ä¸­çš„å˜é‡å«ä¹‰å’Œç‰©ç†/æ•°å­¦æ„ä¹‰ã€‚
        `;

        const result = await callGeminiAPI(prompt);
        loadingOverlay.style.display = 'none';

        if (result) {
            modalContent.innerText = result;
            modalOverlay.style.display = 'flex';
        }
    }

    function closeModal() {
        modalOverlay.style.display = 'none';
    }

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) closeModal();
    });

</script>

</body>
</html>
