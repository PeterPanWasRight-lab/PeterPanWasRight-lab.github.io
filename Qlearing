import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Play, Pause, RotateCcw, FastForward, Info, Settings, Map as MapIcon, TrendingUp } from 'lucide-react';

/**
 * å¼ºåŒ–å­¦ä¹ å¯è§†åŒ– - è¥¿æ¹–å¯»å® (RL West Lake)
 * åŸºäºç”¨æˆ·æä¾›çš„ MATLAB ä»£ç é€»è¾‘é‡æ„ä¸ºäº¤äº’å¼ Web åº”ç”¨
 */

// --- å¸¸é‡å®šä¹‰ ---
const GRID_SIZE = 6;
const CELL_SIZE = 60;
const ACTIONS = ['UP', 'DOWN', 'LEFT', 'RIGHT'];
const ACTION_DELTAS = {
  UP: { x: 0, y: -1 },
  DOWN: { x: 0, y: 1 },
  LEFT: { x: -1, y: 0 },
  RIGHT: { x: 1, y: 0 },
};

// åœ°å›¾å®šä¹‰: 0=ç©ºåœ°, 1=èµ·ç‚¹, 2=ç»ˆç‚¹, -1=éšœç¢/æ°´
// è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿè¥¿æ¹–çš„ç®€åŒ–åœ°å›¾ï¼Œä¸­é—´æœ‰æ°´åŸŸ
const INITIAL_MAP = [
  [1, 0, 0, 0, 0, 0],
  [0, -1, -1, 0, 0, 0],
  [0, -1, -1, -1, 0, 0],
  [0, 0, 0, -1, 0, 0],
  [0, 0, 0, -1, 0, 2],
  [0, 0, 0, 0, 0, 0],
];

const REWARDS = {
  GOAL: 100,
  TRAP: -100,
  STEP: -1,
};

// --- è¾…åŠ©å‡½æ•° ---

// åˆå§‹åŒ– Q è¡¨ (State x Action)
const initQTable = () => {
  const table = {};
  for (let y = 0; y < GRID_SIZE; y++) {
    for (let x = 0; x < GRID_SIZE; x++) {
      table[`${x},${y}`] = { UP: 0, DOWN: 0, LEFT: 0, RIGHT: 0 };
    }
  }
  return table;
};

// è·å–æœ€å¤§ Q å€¼å’Œå¯¹åº”åŠ¨ä½œ
const getMaxQ = (qValues) => {
  let maxVal = -Infinity;
  let bestAction = null;
  ACTIONS.forEach(action => {
    if (qValues[action] > maxVal) {
      maxVal = qValues[action];
      bestAction = action;
    }
  });
  return { maxVal, bestAction };
};

// Epsilon-Greedy ç­–ç•¥
const chooseAction = (x, y, qTable, epsilon) => {
  if (Math.random() < epsilon) {
    // æ¢ç´¢
    return ACTIONS[Math.floor(Math.random() * ACTIONS.length)];
  } else {
    // åˆ©ç”¨
    const stateKey = `${x},${y}`;
    const { bestAction } = getMaxQ(qTable[stateKey]);
    // å¦‚æœæ‰€æœ‰å€¼éƒ½ä¸€æ ·ï¼ˆæ¯”å¦‚åˆå§‹çŠ¶æ€ï¼‰ï¼Œéšæœºé€‰ä¸€ä¸ª
    const allSame = ACTIONS.every(a => qTable[stateKey][a] === qTable[stateKey][ACTIONS[0]]);
    if (allSame) return ACTIONS[Math.floor(Math.random() * ACTIONS.length)];
    return bestAction;
  }
};

const App = () => {
  // --- State ---
  const [map, setMap] = useState(INITIAL_MAP);
  const [agentPos, setAgentPos] = useState({ x: 0, y: 0 });
  const [qTable, setQTable] = useState(initQTable());
  const [episode, setEpisode] = useState(0);
  const [stepCount, setStepCount] = useState(0);
  const [totalReward, setTotalReward] = useState(0);
  const [history, setHistory] = useState([]); // è®°å½•æ¯è½®çš„å›æŠ¥ç”¨äºç»˜å›¾
  
  // æ§åˆ¶å‚æ•°
  const [isRunning, setIsRunning] = useState(false);
  const [speed, setSpeed] = useState(100); // ms per step
  const [algorithm, setAlgorithm] = useState('Q-Learning'); // 'Q-Learning' or 'Sarsa'
  
  // è¶…å‚æ•°
  const [alpha, setAlpha] = useState(0.1); // å­¦ä¹ ç‡
  const [gamma, setGamma] = useState(0.9); // æŠ˜æ‰£å› å­
  const [epsilon, setEpsilon] = useState(0.1); // æ¢ç´¢ç‡

  // Sarsa éœ€è¦è®°å½•ä¸Šä¸€æ­¥çš„åŠ¨ä½œ
  const nextActionRef = useRef(null);
  
  // å¼•ç”¨ä»¥åœ¨ interval ä¸­è·å–æœ€æ–° state
  const stateRef = useRef({
    agentPos,
    qTable,
    episode,
    stepCount,
    totalReward,
    map,
    algorithm,
    alpha,
    gamma,
    epsilon,
    history
  });

  useEffect(() => {
    stateRef.current = { 
      agentPos, qTable, episode, stepCount, totalReward, map, algorithm, alpha, gamma, epsilon, history 
    };
  }, [agentPos, qTable, episode, stepCount, totalReward, map, algorithm, alpha, gamma, epsilon, history]);

  // --- æ ¸å¿ƒ RL é€»è¾‘ ---

  const resetEpisode = useCallback(() => {
    setAgentPos({ x: 0, y: 0 });
    setStepCount(0);
    setTotalReward(0);
    nextActionRef.current = null; // Sarsa é‡ç½®
  }, []);

  const fullReset = () => {
    setIsRunning(false);
    setQTable(initQTable());
    setEpisode(0);
    setHistory([]);
    resetEpisode();
  };

  const step = useCallback(() => {
    const { 
      agentPos: currPos, 
      qTable: currQ, 
      map: currMap, 
      totalReward: currTotalReward, 
      algorithm: currAlgo,
      alpha: lr, 
      gamma: df, 
      epsilon: eps,
      episode: currEp,
      history: currHist
    } = stateRef.current;

    const stateKey = `${currPos.x},${currPos.y}`;
    
    // 1. é€‰æ‹©åŠ¨ä½œ (Action Selection)
    let action;
    if (currAlgo === 'Sarsa' && nextActionRef.current) {
      action = nextActionRef.current;
    } else {
      action = chooseAction(currPos.x, currPos.y, currQ, eps);
    }

    // 2. æ‰§è¡ŒåŠ¨ä½œ (Execute Action)
    const delta = ACTION_DELTAS[action];
    let nextX = currPos.x + delta.x;
    let nextY = currPos.y + delta.y;

    // è¾¹ç•Œæ£€æŸ¥ & æ’å¢™å¤„ç† (ä¿æŒåŸåœ°)
    if (nextX < 0 || nextX >= GRID_SIZE || nextY < 0 || nextY >= GRID_SIZE) {
      nextX = currPos.x;
      nextY = currPos.y;
    }

    // 3. è§‚å¯Ÿå¥–åŠ± (Observe Reward)
    const cellType = currMap[nextY][nextX];
    let reward = REWARDS.STEP;
    let isTerminal = false;

    if (cellType === 2) {
      reward = REWARDS.GOAL;
      isTerminal = true;
    } else if (cellType === -1) {
      reward = REWARDS.TRAP;
      // ä¿®æ”¹ï¼šæ‰è¿›æ°´é‡Œä¸å†ç»“æŸï¼Œè€Œæ˜¯å…è®¸è¿›å…¥ï¼ˆæ‰£åˆ†ï¼‰ï¼Œéœ€è¦è‡ªå·±èµ°å‡ºæ¥
      isTerminal = false; 
    }

    const nextStateKey = `${nextX},${nextY}`;
    const newQ = { ...currQ };
    const currentQVal = newQ[stateKey][action];

    // 4. æ›´æ–° Q å€¼ (Update)
    if (currAlgo === 'Q-Learning') {
      // Q-Learning: Off-policy (æ€»æ˜¯è´ªå©ªåœ°çœ‹ä¸‹ä¸€æ­¥çš„æœ€å¤§å€¼)
      const { maxVal: maxNextQ } = getMaxQ(newQ[nextStateKey]);
      const target = reward + (isTerminal ? 0 : df * maxNextQ);
      newQ[stateKey][action] = currentQVal + lr * (target - currentQVal);
    } else {
      // Sarsa: On-policy (é€‰æ‹©ä¸‹ä¸€æ­¥å®é™…ä¼šèµ°çš„åŠ¨ä½œ)
      const nextAction = chooseAction(nextX, nextY, newQ, eps);
      nextActionRef.current = nextAction; // å­˜ä¸‹æ¥ç»™ä¸‹ä¸€æ­¥ç”¨
      const nextQVal = newQ[nextStateKey][nextAction];
      
      const target = reward + (isTerminal ? 0 : df * nextQVal);
      newQ[stateKey][action] = currentQVal + lr * (target - currentQVal);
    }

    // 5. æ›´æ–°çŠ¶æ€
    setQTable(newQ);
    setTotalReward(currTotalReward + reward);
    setStepCount(prev => prev + 1);

    if (isTerminal) {
      // å›åˆç»“æŸ
      setEpisode(ep => ep + 1);
      setHistory([...currHist, currTotalReward + reward].slice(-50)); // åªä¿ç•™æœ€è¿‘50æ¡
      resetEpisode();
    } else {
      setAgentPos({ x: nextX, y: nextY });
    }

  }, [resetEpisode]);

  // è‡ªåŠ¨è¿è¡Œå¾ªç¯
  useEffect(() => {
    let intervalId;
    if (isRunning) {
      intervalId = setInterval(step, speed);
    }
    return () => clearInterval(intervalId);
  }, [isRunning, speed, step]);


  // --- æ¸²æŸ“ç»„ä»¶ ---

  // æ¸²æŸ“å•ä¸ªæ ¼å­
  const renderCell = (x, y) => {
    const cellType = map[y][x];
    const isAgent = agentPos.x === x && agentPos.y === y;
    const stateKey = `${x},${y}`;
    const qValues = qTable[stateKey];
    const { maxVal, bestAction } = getMaxQ(qValues);
    
    // èƒŒæ™¯é¢œè‰²ï¼šæ ¹æ® maxQ å€¼å†³å®šçº¢ç»¿ (Value Map)
    // ç®€å•çš„å½’ä¸€åŒ–: -100 (çº¢) åˆ° 100 (ç»¿)
    let bgColor = 'bg-gray-100';
    let opacity = 0.1;
    
    if (cellType === -1) {
      bgColor = 'bg-red-200'; // éšœç¢ç‰©å›ºå®šé¢œè‰²
      opacity = 1;
    } else if (cellType === 2) {
      bgColor = 'bg-yellow-200'; // ç»ˆç‚¹
      opacity = 1;
    } else {
       // æ ¹æ®ä»·å€¼æ¸²æŸ“çƒ­åŠ›å›¾
       if (maxVal > 0) {
         opacity = Math.min(maxVal / 100, 1);
         bgColor = `rgba(34, 197, 94, ${0.1 + opacity * 0.9})`; // Green
       } else if (maxVal < 0) {
         opacity = Math.min(Math.abs(maxVal) / 100, 1);
         bgColor = `rgba(239, 68, 68, ${0.1 + opacity * 0.9})`; // Red
       }
    }

    // ç­–ç•¥ç®­å¤´æ—‹è½¬è§’åº¦
    const rotation = {
      UP: 'rotate-0',
      RIGHT: 'rotate-90',
      DOWN: 'rotate-180',
      LEFT: '-rotate-90',
    }[bestAction] || 'rotate-0';

    return (
      <div
        key={`${x}-${y}`}
        className="relative border border-gray-300 flex items-center justify-center text-xs transition-colors duration-200"
        style={{ 
          width: CELL_SIZE, 
          height: CELL_SIZE,
          backgroundColor: cellType !== -1 && cellType !== 2 ? bgColor : undefined,
        }}
      >
        {/* ç‰¹æ®Šåœ°å½¢æ¸²æŸ“ */}
        {cellType === -1 && <div className="absolute inset-0 bg-blue-300 opacity-50 flex items-center justify-center">ğŸ’§</div>}
        {cellType === 1 && <div className="absolute top-1 left-1 text-[10px] font-bold text-gray-500">START</div>}
        {cellType === 2 && <div className="text-2xl">ğŸš©</div>}

        {/* ç­–ç•¥ç®­å¤´ (Policy) - åªæœ‰éç»ˆæ­¢çŠ¶æ€æ˜¾ç¤º */}
        {cellType !== 2 && (maxVal !== 0) && (
          <div className={`absolute inset-0 flex items-center justify-center text-gray-500 opacity-30 transform ${rotation} pointer-events-none`}>
            â¬†
          </div>
        )}

        {/* æ™ºèƒ½ä½“ */}
        {isAgent && (
          <div className="absolute z-10 text-3xl transition-all duration-100 transform scale-110">
            ğŸ¤ 
          </div>
        )}
        
        {/* Value æ˜¾ç¤º (å§‹ç»ˆæ˜¾ç¤º) */}
        <div className="absolute bottom-0.5 right-0.5 z-20 pointer-events-none">
          <span className="text-[9px] font-mono font-bold text-slate-700 bg-white/60 px-0.5 rounded shadow-sm backdrop-blur-[1px]">
            {maxVal.toFixed(1)}
          </span>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
      <header className="max-w-6xl mx-auto mb-8 flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-indigo-700 flex items-center gap-2">
            <MapIcon className="w-8 h-8" />
            è¥¿æ¹–å¯»å® RLWestLake
          </h1>
          <p className="text-slate-500 mt-1">åŸºäºå¼ºåŒ–å­¦ä¹ çš„äº¤äº’å¼å¯»è·¯å¯è§†åŒ– (Q-Learning / Sarsa)</p>
        </div>
        <div className="flex gap-4">
           <a href="#" className="text-sm text-indigo-600 hover:underline">æŸ¥çœ‹æ•™ç¨‹</a>
        </div>
      </header>

      <main className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* å·¦ä¾§ï¼šå¯è§†åŒ–ç½‘æ ¼ */}
        <div className="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 flex flex-col items-center">
          <div className="mb-4 flex items-center justify-between w-full px-4">
            <h2 className="text-xl font-semibold flex items-center gap-2">
              <div className={`w-3 h-3 rounded-full ${isRunning ? 'bg-green-500 animate-pulse' : 'bg-gray-400'}`}></div>
              {isRunning ? 'è®­ç»ƒä¸­...' : 'å‡†å¤‡å°±ç»ª'}
            </h2>
            <div className="text-sm text-slate-500">
              Episode: <span className="font-mono font-bold text-slate-800">{episode}</span>
            </div>
          </div>

          <div 
            className="grid gap-1 bg-gray-200 border-4 border-gray-700 p-1 rounded-md shadow-inner"
            style={{ gridTemplateColumns: `repeat(${GRID_SIZE}, min-content)` }}
          >
            {map.map((row, y) => row.map((_, x) => renderCell(x, y)))}
          </div>

          <div className="mt-6 flex flex-wrap gap-4 items-center justify-center text-sm text-slate-600">
            <div className="flex items-center gap-1"><span className="w-4 h-4 bg-yellow-200 border border-gray-300"></span> ç»ˆç‚¹ (+100)</div>
            <div className="flex items-center gap-1"><span className="w-4 h-4 bg-blue-300 border border-gray-300"></span> æ°´åŸŸ (-100)</div>
            <div className="flex items-center gap-1"><span className="w-4 h-4 bg-green-200 border border-gray-300"></span> é«˜ä»·å€¼åŒº</div>
            <div className="flex items-center gap-1"><span className="w-4 h-4 bg-red-200 border border-gray-300"></span> ä½ä»·å€¼åŒº</div>
          </div>
          
          {/* è®­ç»ƒæ›²çº¿ç®€æ˜“å›¾ */}
          <div className="w-full mt-6 h-32 bg-slate-50 rounded border border-slate-200 relative overflow-hidden flex items-end px-2 gap-1">
             {history.length === 0 && <div className="absolute inset-0 flex items-center justify-center text-gray-400 text-sm">æš‚æ— è®­ç»ƒæ•°æ®</div>}
             {history.map((val, idx) => {
               // å½’ä¸€åŒ–é«˜åº¦ç»˜åˆ¶æ¡å½¢å›¾
               const height = Math.min(Math.max((val + 200) / 400 * 100, 5), 100); 
               const color = val > 0 ? 'bg-green-400' : 'bg-red-400';
               return (
                 <div key={idx} style={{height: `${height}%`, width: `${100/50}%`}} className={`${color} opacity-70 rounded-t-sm`} title={`Reward: ${val}`}></div>
               );
             })}
          </div>
          <div className="w-full text-center text-xs text-gray-400 mt-1">æœ€è¿‘ 50 ä¸ªå›åˆçš„æ€»å¥–åŠ±è¶‹åŠ¿</div>
        </div>

        {/* å³ä¾§ï¼šæ§åˆ¶é¢æ¿ */}
        <div className="space-y-6">
          
          {/* æ§åˆ¶å¡ç‰‡ */}
          <div className="bg-white rounded-xl shadow-lg p-6">
            <div className="flex items-center gap-2 mb-4 text-slate-800 font-semibold border-b pb-2">
              <Settings className="w-5 h-5" />
              å‚æ•°æ§åˆ¶
            </div>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">ç®—æ³•é€‰æ‹©</label>
                <div className="flex rounded-md shadow-sm" role="group">
                  <button
                    type="button"
                    onClick={() => { if(!isRunning) setAlgorithm('Q-Learning'); }}
                    className={`px-4 py-2 text-sm font-medium border rounded-l-lg flex-1 ${
                      algorithm === 'Q-Learning' 
                        ? 'bg-indigo-600 text-white border-indigo-600' 
                        : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                    }`}
                  >
                    Q-Learning
                  </button>
                  <button
                    type="button"
                    onClick={() => { if(!isRunning) setAlgorithm('Sarsa'); }}
                    className={`px-4 py-2 text-sm font-medium border rounded-r-lg flex-1 ${
                      algorithm === 'Sarsa' 
                        ? 'bg-indigo-600 text-white border-indigo-600' 
                        : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'
                    }`}
                  >
                    Sarsa
                  </button>
                </div>
                <p className="text-xs text-slate-400 mt-1">
                  {algorithm === 'Q-Learning' ? 'Off-policy: å¤§èƒ†æ¢ç´¢ï¼Œå­¦ä¹ æœ€ä¼˜è·¯å¾„ã€‚' : 'On-policy: è°¨å°æ…å¾®ï¼Œå­¦ä¹ å®‰å…¨è·¯å¾„ã€‚'}
                </p>
              </div>

              <div>
                <label className="flex justify-between text-sm font-medium text-slate-600 mb-1">
                  <span>è¿è¡Œé€Ÿåº¦</span>
                  <span>{speed}ms</span>
                </label>
                <input 
                  type="range" min="10" max="500" step="10" 
                  value={speed} 
                  onChange={(e) => setSpeed(Number(e.target.value))}
                  className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                />
                <div className="flex justify-between text-xs text-gray-400 mt-1">
                  <span>å¿«</span>
                  <span>æ…¢</span>
                </div>
              </div>

              <div className="grid grid-cols-1 gap-4 pt-2">
                 {/* è¶…å‚æ•°æ»‘å— */}
                 {[
                   { label: 'æ¢ç´¢ç‡ (Epsilon)', val: epsilon, set: setEpsilon, min: 0, max: 1, step: 0.05, tip: 'è¶Šé«˜è¶Šå–œæ¬¢éšæœºä¹±èµ°' },
                   { label: 'å­¦ä¹ ç‡ (Alpha)', val: alpha, set: setAlpha, min: 0.01, max: 1, step: 0.05, tip: 'æ›´æ–°Qå€¼çš„æ­¥é•¿' },
                   { label: 'æŠ˜æ‰£å› å­ (Gamma)', val: gamma, set: setGamma, min: 0.1, max: 0.99, step: 0.05, tip: 'è¶Šé‡è§†æœªæ¥çš„å¥–åŠ±' },
                 ].map((param, idx) => (
                   <div key={idx}>
                     <label className="flex justify-between text-xs font-medium text-slate-600">
                       <span title={param.tip}>{param.label}</span>
                       <span>{param.val.toFixed(2)}</span>
                     </label>
                     <input 
                        type="range" min={param.min} max={param.max} step={param.step}
                        value={param.val}
                        onChange={(e) => param.set(Number(e.target.value))}
                        className="w-full h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-400"
                      />
                   </div>
                 ))}
              </div>
            </div>

            <div className="mt-6 flex gap-2">
              <button
                onClick={() => setIsRunning(!isRunning)}
                className={`flex-1 py-2 px-4 rounded-lg flex items-center justify-center gap-2 font-semibold shadow-md transition-colors ${
                  isRunning 
                    ? 'bg-amber-500 hover:bg-amber-600 text-white' 
                    : 'bg-green-600 hover:bg-green-700 text-white'
                }`}
              >
                {isRunning ? <><Pause className="w-4 h-4"/> æš‚åœ</> : <><Play className="w-4 h-4"/> å¼€å§‹è®­ç»ƒ</>}
              </button>
              
              <button
                onClick={fullReset}
                className="py-2 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg shadow-sm border border-gray-300"
                title="é‡ç½®ç¯å¢ƒ"
              >
                <RotateCcw className="w-5 h-5" />
              </button>
            </div>
          </div>

          {/* ä¿¡æ¯å¡ç‰‡ */}
          <div className="bg-white rounded-xl shadow-lg p-6 text-sm text-slate-600 space-y-3">
             <h3 className="font-semibold text-slate-800 flex items-center gap-2">
               <Info className="w-4 h-4" /> çŠ¶æ€é¢æ¿
             </h3>
             <div className="flex justify-between border-b pb-2">
               <span>å½“å‰æ­¥æ•°:</span>
               <span className="font-mono text-slate-800">{stepCount}</span>
             </div>
             <div className="flex justify-between border-b pb-2">
               <span>å½“å‰å›æŠ¥:</span>
               <span className={`font-mono font-bold ${totalReward < 0 ? 'text-red-500' : 'text-green-600'}`}>
                 {totalReward}
               </span>
             </div>
             <div className="flex justify-between items-center pt-1">
                <span>åæ ‡:</span>
                <code className="bg-slate-100 px-2 py-1 rounded">({agentPos.x}, {agentPos.y})</code>
             </div>
          </div>
        </div>
      </main>

      {/* åº•éƒ¨è¯´æ˜ */}
      <footer className="max-w-6xl mx-auto mt-12 text-center text-slate-400 text-sm pb-8">
        <p>Â© 2026 WestLake RL Lab. åŸºäºæ‚¨ä¸Šä¼ çš„ MATLAB ä»£ç é€»è¾‘é‡æ„ã€‚</p>
        <p className="mt-2">
          Tip: Q-Learning åœ¨è¿™ç§æœ‰æƒ©ç½šåœ°å½¢ï¼ˆæ°´åŸŸï¼‰çš„ç¯å¢ƒä¸‹ï¼Œé€šå¸¸ä¼šå­¦ä¹ å‡ºç´§è´´æ°´è¾¹è¡Œèµ°çš„æœ€çŸ­è·¯å¾„ï¼ˆé™©è·¯ï¼‰ï¼Œ
          è€Œ Sarsa å› ä¸ºè€ƒè™‘äº†æ¢ç´¢æ—¶çš„éšæœºæ€§ï¼Œé€šå¸¸ä¼šå­¦ä¹ å‡ºç¦»æ°´è¿œä¸€ç‚¹çš„å®‰å…¨è·¯å¾„ã€‚
        </p>
      </footer>
    </div>
  );
};

export default App;
